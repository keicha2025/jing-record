<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日日記 | Nichi-Nichi Log</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #FDFCFB; color: #4A4A4A; -webkit-tap-highlight-color: transparent; }
        .muji-shadow { box-shadow: 0 2px 15px rgba(0,0,0,0.03); }
        .material-symbols-rounded { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
        .active-tab { color: #8C8279; font-weight: 500; }
        input, select, textarea { border: 1px solid #E5E5E5 !important; border-radius: 8px !important; padding: 10px !important; outline: none; }
        input:focus { border-color: #D1C7BD !important; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
        <!-- 頂部標題 -->
        <header class="p-6 pb-2">
            <h1 class="text-xl font-light tracking-widest text-gray-400">NICHI-NICHI LOG</h1>
            <p class="text-xs text-gray-300">留學生活記帳</p>
        </header>

        <!-- 主要內容區 -->
        <main class="flex-grow p-4 mb-20 overflow-y-auto">
            
            <!-- 分頁 1: 總覽 -->
            <div v-if="currentTab === 'overview'" class="space-y-6">
                <div class="bg-white p-6 rounded-2xl muji-shadow border border-gray-50">
                    <p class="text-xs text-gray-400 mb-1">本月生活花費預估</p>
                    <h2 class="text-3xl font-light">¥ {{ formatNumber(monthlyTotal) }}</h2>
                    <p class="text-sm text-gray-300 mt-1">≈ NT$ {{ formatNumber(monthlyTotal * fxRate) }}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-xl muji-shadow text-center">
                        <p class="text-[10px] text-gray-400">待收代墊</p>
                        <p class="text-lg">¥ {{ formatNumber(debtTotal) }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl muji-shadow text-center border-l-4 border-[#E0D7C6]">
                        <p class="text-[10px] text-gray-400">留學總投入</p>
                        <p class="text-lg">¥ {{ formatNumber(allTimeTotal) }}</p>
                    </div>
                </div>
            </div>

            <!-- 分頁 2: 明細 (簡化版) -->
            <div v-if="currentTab === 'history'" class="space-y-3">
                <div v-for="item in transactions" :key="item.id" class="bg-white p-4 rounded-xl muji-shadow flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <span class="material-symbols-rounded text-gray-400">{{ getIcon(item.categoryId) }}</span>
                        <div>
                            <p class="text-sm">{{ item.name }}</p>
                            <p class="text-[10px] text-gray-300">{{ item.spendDate }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium">¥ {{ formatNumber(item.amountJPY) }}</p>
                        <p v-if="item.isOneTime" class="text-[8px] bg-gray-100 px-1 rounded text-gray-400">一次性</p>
                    </div>
                </div>
            </div>

            <!-- 分頁 3: 新增 (核心功能) -->
            <div v-if="currentTab === 'add'" class="bg-white p-6 rounded-2xl muji-shadow space-y-5">
                <!-- 支出/收入 切換 -->
                <div class="flex bg-gray-50 rounded-lg p-1">
                    <button @click="form.type = '支出'" :class="{'bg-white shadow-sm': form.type === '支出'}" class="flex-1 py-2 text-sm rounded-md transition-all">支出</button>
                    <button @click="form.type = '收入'" :class="{'bg-white shadow-sm': form.type === '收入'}" class="flex-1 py-2 text-sm rounded-md transition-all">收入</button>
                </div>

                <!-- 金額輸入 -->
                <div class="relative">
                    <span class="absolute left-3 top-3 text-gray-400 text-sm">{{ form.currency }}</span>
                    <input type="number" v-model="form.amount" class="w-full text-right text-2xl font-light pr-4 py-4" placeholder="0">
                    <button @click="toggleCurrency" class="absolute left-3 bottom-[-25px] text-[10px] text-gray-300 underline">切換幣別</button>
                </div>

                <!-- 日期 -->
                <div class="flex flex-col space-y-1 pt-4">
                    <label class="text-[10px] text-gray-400 uppercase tracking-widest">消費日期</label>
                    <input type="date" v-model="form.spendDate" class="w-full text-sm">
                </div>

                <!-- 分類 -->
                <div class="grid grid-cols-4 gap-4 py-2">
                    <div v-for="cat in categories" :key="cat.id" 
                         @click="form.categoryId = cat.id"
                         :class="{'border-[#D1C7BD] bg-gray-50': form.categoryId === cat.id}"
                         class="flex flex-col items-center p-2 border border-transparent rounded-xl transition-all">
                        <span class="material-symbols-rounded text-gray-400">{{ cat.icon }}</span>
                        <span class="text-[10px] mt-1">{{ cat.name }}</span>
                    </div>
                </div>

                <input type="text" v-model="form.name" placeholder="項目名稱 (例如: 吉野家)" class="w-full text-sm">
                <textarea v-model="form.note" placeholder="備忘錄..." class="w-full text-sm h-20"></textarea>

                <!-- 支付方式 -->
                <select v-model="form.paymentMethod" class="w-full text-sm bg-white">
                    <option value="現金">現金</option>
                    <option value="信用卡">信用卡</option>
                    <option value="掃碼支付">掃碼支付 (PayPay)</option>
                    <option value="郵局匯款">郵局匯款</option>
                </select>

                <!-- 進階開關 -->
                <div class="space-y-3 pt-2">
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" v-model="form.isOneTime" class="w-4 h-4">
                        <span class="text-xs text-gray-500">這是一次性大筆支出 (不計入日常)</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" v-model="form.isSplit" class="w-4 h-4">
                        <span class="text-xs text-gray-500">幫朋友代墊 / 需分帳</span>
                    </label>
                </div>

                <!-- 分帳細節 -->
                <div v-if="form.isSplit" class="bg-gray-50 p-4 rounded-xl space-y-3">
                    <div class="flex justify-between items-center text-xs">
                        <span>我的份額</span>
                        <input type="number" v-model="form.personalShare" class="w-24 text-right">
                    </div>
                    <p class="text-[10px] text-gray-400 text-right">代墊金額: ¥ {{ form.amount - form.personalShare }}</p>
                </div>

                <button @click="submitForm" :disabled="loading" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl text-sm font-light tracking-widest disabled:bg-gray-300">
                    {{ loading ? '傳送中...' : '確認紀錄' }}
                </button>
            </div>

            <!-- 其他分頁 (開發中提示) -->
            <div v-if="['stats', 'settings'].includes(currentTab)" class="flex flex-col items-center justify-center h-64 text-gray-300">
                <span class="material-symbols-rounded text-4xl mb-2">construction</span>
                <p class="text-xs">統計與設定功能開發中</p>
            </div>

        </main>

        <!-- 底部導航欄 -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center safe-area-bottom z-50">
            <button @click="currentTab = 'overview'" :class="{'active-tab': currentTab === 'overview'}" class="p-4 flex flex-col items-center">
                <span class="material-symbols-rounded">dashboard</span>
            </button>
            <button @click="currentTab = 'history'" :class="{'active-tab': currentTab === 'history'}" class="p-4 flex flex-col items-center">
                <span class="material-symbols-rounded">list_alt</span>
            </button>
            <button @click="currentTab = 'add'" :class="{'active-tab': currentTab === 'add'}" class="p-4 flex flex-col items-center bg-gray-50 rounded-full mb-8 muji-shadow">
                <span class="material-symbols-rounded">add</span>
            </button>
            <button @click="currentTab = 'stats'" :class="{'active-tab': currentTab === 'stats'}" class="p-4 flex flex-col items-center">
                <span class="material-symbols-rounded">bar_chart</span>
            </button>
            <button @click="currentTab = 'settings'" :class="{'active-tab': currentTab === 'settings'}" class="p-4 flex flex-col items-center">
                <span class="material-symbols-rounded">settings</span>
            </button>
        </nav>

        <!-- 簡單通知 -->
        <div v-if="toast" class="fixed top-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-2 rounded-full text-xs z-[100]">
            {{ toast }}
        </div>
    </div>

    <script>
        // --- 設定區：請將你的 GAS 網址貼在下方 ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzmNuifzAXQWvQC9lj2Yn2jOKHgSPKX2XnbxCx1ycmR044V_We8aEn1KC5nwXlyWG5S/exec";
        // ------------------------------------

        const { createApp, ref, onMounted, computed } = Vue;

        createApp({
            setup() {
                const currentTab = ref('add');
                const loading = ref(false);
                const toast = ref(null);
                const categories = ref([]);
                const fxRate = ref(0.22);
                const transactions = ref([]); // 真實環境中應從 GAS 抓取

                const form = ref({
                    type: '支出',
                    currency: 'JPY',
                    amount: '',
                    spendDate: new Date().toISOString().split('T')[0],
                    categoryId: 'cat_001',
                    name: '',
                    note: '',
                    paymentMethod: '現金',
                    isOneTime: false,
                    isSplit: false,
                    personalShare: 0
                });

                // 模擬數據 (實際應從歷史紀錄統計)
                const monthlyTotal = computed(() => 125800);
                const debtTotal = computed(() => 3000);
                const allTimeTotal = computed(() => 850000);

                const fetchInitialData = async () => {
                    try {
                        const res = await fetch(GAS_URL);
                        const data = await res.json();
                        categories.value = data.categories;
                        fxRate.value = data.config.fx_rate;
                    } catch (e) {
                        showToast("連線失敗，請檢查 GAS 部署");
                    }
                };

                const toggleCurrency = () => {
                    form.value.currency = form.value.currency === 'JPY' ? 'TWD' : 'JPY';
                };

                const getIcon = (id) => {
                    const cat = categories.value.find(c => c.id === id);
                    return cat ? cat.icon : 'sell';
                };

                const formatNumber = (num) => new Intl.NumberFormat().format(num);

                const showToast = (msg) => {
                    toast.value = msg;
                    setTimeout(() => toast.value = null, 3000);
                };

                const submitForm = async () => {
                    if (!form.value.amount || !form.value.name) {
                        showToast("請填寫金額與名稱");
                        return;
                    }

                    loading.value = true;
                    
                    const payload = {
                        ...form.value,
                        amountJPY: form.value.currency === 'JPY' ? form.value.amount : form.value.amount / fxRate.value,
                        amountTWD: form.value.currency === 'TWD' ? form.value.amount : form.value.amount * fxRate.value,
                        debtAmount: form.value.isSplit ? (form.value.amount - form.value.personalShare) : 0
                    };

                    try {
                        await fetch(GAS_URL, {
                            method: 'POST',
                            mode: 'no-cors', // GAS 需要 no-cors
                            body: JSON.stringify(payload)
                        });
                        
                        showToast("紀錄成功！");
                        // 重置表單
                        form.value.amount = '';
                        form.value.name = '';
                        form.value.note = '';
                        currentTab.value = 'history';
                    } catch (e) {
                        showToast("儲存失敗");
                    } finally {
                        loading.value = false;
                    }
                };

                onMounted(fetchInitialData);

                return {
                    currentTab, loading, toast, categories, form, transactions, fxRate,
                    monthlyTotal, debtTotal, allTimeTotal,
                    toggleCurrency, getIcon, formatNumber, submitForm
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
