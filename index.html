<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>日日記 | Nichi-Nichi Log</title>

    <!-- PWA 核心設定 -->
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <meta name="theme-color" content="#4A4A4A">

    <!-- iOS 專屬優化 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="日日記">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2544/2544087.png">

    <!-- 外部資源 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Sans+JP:wght@300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="style.css">
    <style>
        @keyframes spring-up {
            0% {
                transform: translateY(20px) scale(0.9);
                opacity: 0;
            }

            60% {
                transform: translateY(-5px) scale(1.03);
                opacity: 1;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .animate-spring-up {
            animation: spring-up 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative overflow-hidden" v-cloak>
        <div v-if="loading" class="fixed inset-0 z-[100] loading-overlay flex flex-col items-center justify-center">
            <div class="w-8 h-8 border-2 border-gray-100 border-t-gray-500 rounded-full animate-spin mb-4"></div>
            <p class="text-[10px] tracking-[0.2em] text-gray-400 uppercase font-light">Syncing...</p>
        </div>

        <header class="p-6 pb-2 shrink-0 flex justify-between items-end">
            <h1 class="text-lg font-light tracking-[0.3em] text-gray-300 uppercase">Nichi-Nichi</h1>
            <div class="flex items-center space-x-2">
                <!-- Filter Clear Button -->
                <div v-if="currentTab === 'history' && (historyFilter.mode !== 'all' || historyFilter.friendName || historyFilter.categoryId)"
                    @click="historyFilter = { mode: 'all', categoryId: null, friendName: null, currency: null }"
                    class="flex items-center space-x-1 text-[9px] bg-gray-100 text-gray-400 px-3 py-1.5 rounded-full cursor-pointer">
                    <span class="material-symbols-rounded !text-xs">filter_list_off</span>
                    <span>CLEAR</span>
                </div>

                <!-- Status Icon -->
                <div class="text-gray-300 transition-colors duration-300 flex items-center justify-center w-8 h-8">
                    <!-- Admin: Syncing -->
                    <span v-if="appMode === 'ADMIN' && syncStatus === 'syncing'"
                        class="material-symbols-rounded animate-spin text-gray-400">sync</span>
                    <!-- Admin: Error (Click to retry) -->
                    <span v-else-if="appMode === 'ADMIN' && syncStatus === 'error'" @click="retrySync"
                        class="material-symbols-rounded text-red-300 cursor-pointer animate-pulse">sync_problem</span>
                    <!-- Admin: Idle -->
                    <span v-else-if="appMode === 'ADMIN'"
                        class="material-symbols-rounded text-gray-300">cloud_done</span>
                    <!-- Viewer -->
                    <span v-else-if="appMode === 'VIEWER'"
                        class="material-symbols-rounded text-gray-300">visibility</span>
                    <!-- Guest -->
                    <span v-else class="material-symbols-rounded text-gray-300"
                        title="Guest Mode (Local Only)">cloud_off</span>
                </div>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto px-4 pb-32 no-scrollbar">
            <!-- Viewer Dashboard -->
            <view-dashboard v-if="currentTab === 'overview' && appMode === 'VIEWER'" :transactions="transactions"
                :stats="stats" @switch-tab="currentTab = $event"></view-dashboard>

            <!-- Regular Admin/Guest Dashboard -->
            <overview-page v-else-if="currentTab === 'overview'" :transactions="transactions" :stats="stats"
                :fx-rate="fxRate"
                @go-to-history="historyFilter = { mode: $event.mode, categoryId: null, friendName: null, currency: $event.currency }; currentTab = 'history'"></overview-page>

            <history-page v-if="currentTab === 'history'" :transactions="filteredTransactions" :categories="categories"
                :payment-methods="paymentMethods" :projects="projects" @edit-item="handleEditItem"
                @update-filter="Object.assign(historyFilter, $event)"></history-page>

            <add-page v-if="currentTab === 'add'" :form="form" :categories="categories"
                :payment-methods="paymentMethods" :friends="friends" :projects="projects" :loading="loading"
                @toggle-currency="toggleCurrency" @submit="handleSubmit(form)"
                @add-friend-to-list="handleAddFriendToList" @create-project="handleCreateProject"></add-page>
            <edit-page v-if="currentTab === 'edit'" :form="editForm" :categories="categories"
                :payment-methods="paymentMethods" :friends="friends" :projects="projects" :loading="loading"
                @submit="handleSubmit(editForm)" @delete-item="handleDelete"
                @cancel="currentTab = 'history'; editForm = null;" @create-project="handleCreateProject"></edit-page>
            <stats-page v-if="currentTab === 'stats'" :transactions="transactions" :categories="categories"
                :payment-methods="paymentMethods" :fx-rate="fxRate" :projects="projects"
                @drill-down="handleDrillDown"></stats-page>
            <settings-page v-if="currentTab === 'settings'" :config="systemConfig" :friends="friends"
                :transactions="transactions" :projects="projects" :app-mode="appMode"
                @update-config="handleUpdateConfig" @register-device="handleRegisterDevice"
                @clear-guest-data="clearGuestData" @view-friend="handleViewFriend"
                @view-project="handleViewProject"></settings-page>

            <project-detail-page v-if="currentTab === 'project-detail'" :project="selectedProject"
                :transactions="transactions" @back="currentTab = 'settings'; selectedProject = null"
                @update-project="handleUpdateProject"></project-detail-page>
        </main>

        <footer
            class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-50 px-6 pb-10 pt-4 z-50">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <button v-for="tab in ['overview', 'history', 'add', 'stats', 'settings']" @click="currentTab = tab"
                    v-show="!(appMode === 'VIEWER' && tab === 'add')"
                    :class="[currentTab === tab ? 'text-gray-800' : 'text-gray-200', tab === 'add' ? 'add-btn-wrap' : 'nav-item']">
                    <div v-if="tab === 'add'" class="add-btn active:scale-90 transition-transform"><span
                            class="material-symbols-rounded !text-3xl">add</span></div>
                    <span v-else class="material-symbols-rounded text-2xl">{{ getTabIcon(tab) }}</span>
                </button>
            </div>
        </footer>


        <!-- Success Modal -->
        <success-modal :visible="showSuccessModal" :item="successItem" @close="showSuccessModal = false"
            @view-details="handleViewDetails">
        </success-modal>
    </div>

    <!-- 註冊 Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
    <script src="./js/env.js"></script>
    <script type="module" src="./js/app.js"></script>
</body>

</html>