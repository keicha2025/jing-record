<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日日記 | Nichi-Nichi Log</title>
    <!-- 外部資源 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative overflow-hidden" v-cloak>
        
        <!-- 讀取遮罩 -->
        <div v-if="loading" class="fixed inset-0 z-[100] loading-overlay flex flex-col items-center justify-center">
            <div class="w-8 h-8 border-2 border-gray-200 border-t-gray-500 rounded-full animate-spin mb-4"></div>
            <p class="text-[10px] tracking-[0.2em] text-gray-400 uppercase">Syncing...</p>
        </div>

        <!-- 儲存成功預覽 -->
        <div v-if="lastSaved" class="fixed inset-0 z-[90] flex items-center justify-center p-8 bg-black/5 backdrop-blur-sm">
            <div class="bg-white w-full rounded-[2.5rem] p-10 muji-shadow text-center space-y-6">
                <span class="material-symbols-rounded text-5xl text-gray-200">check_circle</span>
                <div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">Saved Successfully</p>
                    <h3 class="text-3xl font-light">¥ {{ formatNumber(lastSaved.amountJPY) }}</h3>
                    <p class="text-sm text-gray-400 mt-2">{{ lastSaved.name }}</p>
                </div>
                <button @click="lastSaved = null" class="w-full py-4 bg-gray-50 rounded-2xl text-[10px] tracking-[0.2em] uppercase font-medium">Dismiss</button>
            </div>
        </div>

        <header class="p-6 pb-2">
            <h1 class="text-lg font-light tracking-[0.3em] text-gray-300 uppercase">Nichi-Nichi</h1>
        </header>

        <!-- 主要內容 -->
        <main class="flex-grow overflow-y-auto px-4 pb-32 no-scrollbar">
            
            <!-- 分頁: 總覽 -->
            <section v-if="currentTab === 'overview'" class="space-y-6 py-4">
                <div class="bg-white p-8 rounded-[2rem] muji-shadow border border-gray-50">
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-2">Monthly Expenses</p>
                    <h2 class="text-4xl font-light">¥ {{ formatNumber(monthlyTotal) }}</h2>
                    <p class="text-[10px] text-gray-300 mt-2">約 NT$ {{ formatNumber(monthlyTotal * fxRate) }}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-2xl muji-shadow">
                        <p class="text-[10px] text-gray-400 mb-1">待收代墊</p>
                        <p class="text-xl font-light">¥ {{ formatNumber(debtTotal) }}</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl muji-shadow border-l-2 border-gray-100">
                        <p class="text-[10px] text-gray-400 mb-1">留學累計</p>
                        <p class="text-xl font-light">¥ {{ formatNumber(allTimeTotal) }}</p>
                    </div>
                </div>
            </section>

            <!-- 分頁: 新增 -->
            <section v-if="currentTab === 'add'" class="space-y-6 py-4 animate-in fade-in duration-500">
                <div class="bg-white p-6 rounded-[2.5rem] muji-shadow space-y-6">
                    <!-- 收支切換 -->
                    <div class="flex bg-gray-100 rounded-xl p-1 relative">
                        <button @click.stop="form.type = '支出'" :class="form.type === '支出' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-400'" class="flex-1 py-2 text-xs rounded-lg transition-all z-10">支出</button>
                        <button @click.stop="form.type = '收入'" :class="form.type === '收入' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-400'" class="flex-1 py-2 text-xs rounded-lg transition-all z-10">收入</button>
                    </div>

                    <!-- 金額 -->
                    <div class="text-center py-6 border-b border-gray-50">
                        <div class="flex items-center justify-center space-x-3">
                            <span @click.stop="toggleCurrency" class="text-sm font-medium text-gray-300 border border-gray-100 px-3 py-1 rounded-full cursor-pointer">{{ form.currency }}</span>
                            <input type="number" v-model="form.amount" class="text-5xl font-light w-48 text-center bg-transparent outline-none" placeholder="0" inputmode="decimal">
                        </div>
                    </div>

                    <div class="space-y-5">
                        <div class="flex items-center justify-between px-2">
                            <span class="text-[10px] text-gray-400 uppercase tracking-widest">Date</span>
                            <input type="date" v-model="form.spendDate" class="text-sm bg-transparent outline-none text-right">
                        </div>

                        <!-- 分類 -->
                        <div class="grid grid-cols-4 gap-4 py-2">
                            <div v-for="cat in categories" :key="cat.id" @click.stop="form.categoryId = cat.id"
                                 :class="form.categoryId === cat.id ? 'bg-[#4A4A4A] text-white shadow-lg' : 'bg-gray-50 text-gray-300'"
                                 class="flex flex-col items-center p-3 rounded-2xl transition-all">
                                <span class="material-symbols-rounded text-xl">{{ cat.icon }}</span>
                                <span class="text-[9px] mt-1">{{ cat.name }}</span>
                            </div>
                        </div>

                        <input type="text" v-model="form.name" placeholder="項目名稱" class="w-full text-sm py-4 border-b border-gray-50 outline-none">

                        <!-- 支付 -->
                        <div class="flex space-x-2 overflow-x-auto no-scrollbar py-2">
                            <button v-for="m in ['現金', '信用卡', '掃碼支付', '郵局匯款']" @click.stop="form.paymentMethod = m"
                                    :class="m === form.paymentMethod ? 'bg-gray-200 text-gray-700' : 'bg-gray-50 text-gray-300'"
                                    class="whitespace-nowrap px-5 py-2 rounded-full text-[10px] transition-colors">
                                {{ m }}
                            </button>
                        </div>

                        <!-- 開關 -->
                        <div class="space-y-4 pt-4 border-t border-gray-50">
                            <div class="flex items-center justify-between" @click.stop="form.isOneTime = !form.isOneTime">
                                <span class="text-xs text-gray-400">留學一次性大筆支出</span>
                                <div class="w-10 h-5 rounded-full relative transition-colors" :class="form.isOneTime ? 'bg-gray-400' : 'bg-gray-200'">
                                    <div class="absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform" :class="{'translate-x-5': form.isOneTime}"></div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between" @click.stop="form.isSplit = !form.isSplit">
                                <span class="text-xs text-gray-400">幫朋友代墊 / 需分帳</span>
                                <div class="w-10 h-5 rounded-full relative transition-colors" :class="form.isSplit ? 'bg-gray-400' : 'bg-gray-200'">
                                    <div class="absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform" :class="{'translate-x-5': form.isSplit}"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 分帳詳細 -->
                        <div v-if="form.isSplit" class="bg-gray-50 p-6 rounded-3xl space-y-5">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-gray-400">分帳對象</span>
                                <input type="text" v-model="form.friendName" list="friends-list" placeholder="對象名稱" class="text-right bg-transparent outline-none text-xs w-32">
                                <datalist id="friends-list"><option v-for="f in friends" :value="f"></option></datalist>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-gray-400 uppercase tracking-widest">Quick Split</span>
                                <div class="flex space-x-2">
                                    <button v-for="n in [2, 3]" @click.stop="quickSplit(n)" class="px-3 py-1 border border-gray-200 rounded-full text-[10px]">1/{{n}}</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                                <span class="text-[10px] text-gray-500 font-medium">我的份額 ({{ form.currency }})</span>
                                <input type="number" v-model="form.personalShare" class="text-right bg-transparent outline-none text-sm font-medium w-24">
                            </div>
                        </div>
                    </div>

                    <button @click.stop="submitForm" :disabled="loading" class="w-full bg-[#4A4A4A] text-white py-5 rounded-2xl text-xs font-medium tracking-[0.3em] uppercase shadow-lg disabled:bg-gray-200">
                        Confirm & Save
                    </button>
                </div>
            </section>
        </main>

        <!-- 底部導航 -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-50 px-6 pb-10 pt-4 z-50">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <button v-for="tab in ['overview', 'history', 'add', 'stats', 'settings']" 
                        @click="currentTab = tab" 
                        :class="[currentTab === tab ? 'text-gray-800' : 'text-gray-200', tab === 'add' ? 'add-btn-wrap' : 'nav-item']">
                    <div v-if="tab === 'add'" class="add-btn"><span class="material-symbols-rounded !text-3xl">add</span></div>
                    <span v-else class="material-symbols-rounded text-2xl">{{ getTabIcon(tab) }}</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- 模組化載入指令：順序很重要 -->
    <script type="module" src="./js/config.js"></script>
    <script type="module" src="./js/api.js"></script>
    <script type="module" src="./js/app.js"></script>
</body>
</html>
